648cc1f7a6fabd5ab87d81bf57d660ff
/**
 * Generation Studio - WebSocket Operations Module
 * 
 * Handles real-time communication via WebSocket connections.
 */

/**
 * WebSocket management for real-time generation updates
 */
const generationWebSocket = {
  /**
   * Initializes WebSocket connection
   */
  init(callbacks = {}) {
    const {
      onOpen = () => {},
      onMessage = () => {},
      onClose = () => {},
      onError = () => {},
      onReconnect = () => {}
    } = callbacks;
    try {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const wsUrl = `${protocol}//${window.location.host}/ws/generation`;
      const websocket = new WebSocket(wsUrl);
      websocket.onopen = event => {
        this.log('WebSocket connected for generation updates');
        onOpen(event);
      };
      websocket.onmessage = event => {
        try {
          const data = JSON.parse(event.data);
          this.handleMessage(data, onMessage);
        } catch (error) {
          this.log('Failed to parse WebSocket message:', error);
        }
      };
      websocket.onclose = event => {
        this.log('WebSocket disconnected, attempting reconnection...');
        onClose(event);

        // Attempt reconnection after delay
        setTimeout(() => {
          this.log('Attempting WebSocket reconnection...');
          onReconnect();
        }, 5000);
      };
      websocket.onerror = error => {
        this.log('WebSocket error:', error);
        onError(error);
      };
      return websocket;
    } catch (error) {
      this.log('Failed to initialize WebSocket:', error);
      onError(error);
      return null;
    }
  },
  /**
   * Handles incoming WebSocket messages
   */
  handleMessage(data, callback) {
    if (!data || typeof data !== 'object') {
      this.log('Invalid WebSocket message format:', data);
      return;
    }
    const messageInfo = this.parseMessage(data);
    if (messageInfo.isValid) {
      callback(messageInfo);
    } else {
      this.log('Unknown WebSocket message type:', data.type);
    }
  },
  /**
   * Parses and validates WebSocket messages
   */
  parseMessage(data) {
    // Accept either a JSON string (from tests) or an already-parsed object
    let parsed = data;
    if (typeof data === 'string') {
      try {
        parsed = JSON.parse(data);
      } catch (e) {
        return {
          type: null,
          isValid: false,
          payload: null
        };
      }
    }

    // Support messages that may be wrapped in a `payload` envelope
    const envelope = parsed.payload && typeof parsed.payload === 'object' ? parsed.payload : parsed;
    const msgType = parsed?.type || envelope?.type || null;
    const messageInfo = {
      type: msgType,
      isValid: false,
      payload: null
    };
    switch (msgType) {
      case 'generation_progress':
      case 'progress':
        // backwards-compatible alias used in some tests/clients
        if (this.validateProgressMessage(envelope)) {
          messageInfo.isValid = true;
          messageInfo.payload = {
            jobId: envelope.job_id || envelope.jobId,
            progress: envelope.progress,
            status: envelope.status,
            currentStep: envelope.current_step || envelope.currentStep,
            totalSteps: envelope.total_steps || envelope.totalSteps,
            eta: envelope.eta,
            timestamp: envelope.timestamp || Date.now()
          };
        }
        break;
      case 'generation_complete':
      case 'complete':
        if (this.validateCompleteMessage(envelope)) {
          messageInfo.isValid = true;
          messageInfo.payload = {
            jobId: envelope.job_id || envelope.jobId,
            resultId: envelope.result_id || envelope.resultId,
            prompt: envelope.prompt,
            negativePrompt: envelope.negative_prompt || envelope.negativePrompt,
            imageUrl: envelope.image_url || envelope.imageUrl,
            thumbnailUrl: envelope.thumbnail_url || envelope.thumbnailUrl,
            width: envelope.width,
            height: envelope.height,
            steps: envelope.steps,
            cfgScale: envelope.cfg_scale || envelope.cfgScale,
            seed: envelope.seed,
            batchCount: envelope.batch_count || envelope.batchCount,
            batchSize: envelope.batch_size || envelope.batchSize,
            generationTime: envelope.generation_time || envelope.generationTime,
            fileSize: envelope.file_size || envelope.fileSize,
            modelUsed: envelope.model_used || envelope.modelUsed,
            timestamp: envelope.timestamp || Date.now()
          };
        }
        break;
      case 'generation_error':
      case 'error':
        if (this.validateErrorMessage(envelope)) {
          messageInfo.isValid = true;
          messageInfo.payload = {
            jobId: envelope.job_id || envelope.jobId,
            error: envelope.error,
            errorCode: envelope.error_code || envelope.errorCode,
            details: envelope.details,
            timestamp: envelope.timestamp || Date.now()
          };
        }
        break;
      case 'queue_update':
      case 'queue':
        if (this.validateQueueMessage(envelope)) {
          messageInfo.isValid = true;
          messageInfo.payload = {
            jobs: envelope.jobs,
            queueLength: envelope.queue_length || envelope.queueLength,
            processingCount: envelope.processing_count || envelope.processingCount,
            timestamp: envelope.timestamp || Date.now()
          };
        }
        break;
      case 'system_status':
      case 'status':
        if (this.validateSystemMessage(envelope)) {
          messageInfo.isValid = true;
          messageInfo.payload = {
            status: envelope.status,
            memoryUsage: envelope.memory_usage || envelope.memoryUsage,
            gpuUsage: envelope.gpu_usage || envelope.gpuUsage,
            queueLength: envelope.queue_length || envelope.queueLength,
            activeWorkers: envelope.active_workers || envelope.activeWorkers,
            timestamp: envelope.timestamp || Date.now()
          };
        }
        break;
      default:
        this.log('Unknown message type:', msgType);
    }
    return messageInfo;
  },
  /**
   * Validates progress message format
   */
  validateProgressMessage(data) {
    return (data.job_id || data.jobId) && (typeof data.progress === 'number' || !isNaN(Number(data.progress))) && Number(data.progress) >= 0 && Number(data.progress) <= 100;
  },
  /**
   * Validates completion message format
   */
  validateCompleteMessage(data) {
    return (data.job_id || data.jobId) && (data.result_id || data.resultId) && (data.image_url || data.imageUrl) && data.prompt;
  },
  /**
   * Validates error message format
   */
  validateErrorMessage(data) {
    return (data.job_id || data.jobId) && data.error;
  },
  /**
   * Validates queue message format
   */
  validateQueueMessage(data) {
    return Array.isArray(data.jobs) && typeof (data.queue_length || data.queueLength) === 'number';
  },
  /**
   * Validates system status message format
   */
  validateSystemMessage(data) {
    return data.status && typeof data.status === 'object';
  },
  /**
   * Sends a message through WebSocket
   */
  send(websocket, messageType, payload) {
    if (!websocket || websocket.readyState !== WebSocket.OPEN) {
      this.log('WebSocket not available for sending message');
      return false;
    }
    try {
      const message = {
        type: messageType,
        timestamp: Date.now(),
        ...payload
      };
      websocket.send(JSON.stringify(message));
      return true;
    } catch (error) {
      this.log('Failed to send WebSocket message:', error);
      return false;
    }
  },
  /**
   * Requests job status update
   */
  requestJobStatus(websocket, jobId) {
    return this.send(websocket, 'request_job_status', {
      job_id: jobId
    });
  },
  /**
   * Requests queue status
   */
  requestQueueStatus(websocket) {
    return this.send(websocket, 'request_queue_status', {});
  },
  /**
   * Requests system status
   */
  requestSystemStatus(websocket) {
    return this.send(websocket, 'request_system_status', {});
  },
  /**
   * Subscribes to job updates
   */
  subscribeToJob(websocket, jobId) {
    return this.send(websocket, 'subscribe_job', {
      job_id: jobId
    });
  },
  /**
   * Unsubscribes from job updates
   */
  unsubscribeFromJob(websocket, jobId) {
    return this.send(websocket, 'unsubscribe_job', {
      job_id: jobId
    });
  },
  /**
   * Gets WebSocket connection status
   */
  getConnectionStatus(websocket) {
    if (!websocket) {
      return {
        status: 'not_initialized',
        ready: false
      };
    }
    const statusMap = {
      [WebSocket.CONNECTING]: {
        status: 'connecting',
        ready: false
      },
      [WebSocket.OPEN]: {
        status: 'connected',
        ready: true
      },
      [WebSocket.CLOSING]: {
        status: 'closing',
        ready: false
      },
      [WebSocket.CLOSED]: {
        status: 'closed',
        ready: false
      }
    };
    return statusMap[websocket.readyState] || {
      status: 'unknown',
      ready: false
    };
  },
  /**
   * Closes WebSocket connection gracefully
   */
  close(websocket) {
    if (websocket && websocket.readyState === WebSocket.OPEN) {
      websocket.close(1000, 'Component cleanup');
      return true;
    }
    return false;
  },
  /**
   * Creates WebSocket connection manager
   */
  createConnectionManager(callbacks = {}) {
    let websocket = null;
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 5;
    let reconnectDelay = 1000; // Start with 1 second
    let isDestroyed = false;
    const connect = () => {
      if (isDestroyed) return null;
      websocket = this.init({
        onOpen: event => {
          reconnectAttempts = 0;
          reconnectDelay = 1000;
          if (callbacks.onOpen) callbacks.onOpen(event);
        },
        onMessage: messageInfo => {
          if (callbacks.onMessage) callbacks.onMessage(messageInfo);
        },
        onClose: event => {
          if (callbacks.onClose) callbacks.onClose(event);
        },
        onError: error => {
          if (callbacks.onError) callbacks.onError(error);
        },
        onReconnect: () => {
          if (isDestroyed) return;
          if (reconnectAttempts < maxReconnectAttempts) {
            reconnectAttempts++;
            reconnectDelay = Math.min(reconnectDelay * 2, 30000); // Cap at 30 seconds

            setTimeout(() => {
              if (!isDestroyed) {
                this.log(`Reconnection attempt ${reconnectAttempts}/${maxReconnectAttempts}`);
                connect();
              }
            }, reconnectDelay);
          } else {
            this.log('Max reconnection attempts reached');
            if (callbacks.onMaxReconnectAttempts) {
              callbacks.onMaxReconnectAttempts();
            }
          }
        }
      });
      return websocket;
    };
    return {
      connect,
      // Primary send method
      send: (messageType, payload) => this.send(websocket, messageType, payload),
      // Backwards-compatible alias
      sendMessage: (messageType, payload) => this.send(websocket, messageType, payload),
      getStatus: () => this.getConnectionStatus(websocket),
      // Primary close method
      close: () => this.close(websocket),
      // Backwards-compatible alias
      disconnect: () => this.close(websocket),
      destroy: () => {
        isDestroyed = true;
        this.close(websocket);
        websocket = null;
      },
      getWebSocket: () => websocket,
      isConnected: () => {
        const status = this.getConnectionStatus(websocket);
        return status.ready;
      }
    };
  },
  /**
   * Logging utility
   */
  log(message, ...args) {
    if (window.DevLogger) {
      window.DevLogger.info(`[GenerationWebSocket] ${message}`, ...args);
    } else {
      // eslint-disable-next-line no-console
      console.log(`[GenerationWebSocket] ${message}`, ...args);
    }
  }
};

// Export for use in other modules
if (typeof module !== 'undefined' && module.exports) {
  module.exports = {
    generationWebSocket
  };
} else if (typeof window !== 'undefined') {
  window.generationWebSocket = generationWebSocket;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJnZW5lcmF0aW9uV2ViU29ja2V0IiwiaW5pdCIsImNhbGxiYWNrcyIsIm9uT3BlbiIsIm9uTWVzc2FnZSIsIm9uQ2xvc2UiLCJvbkVycm9yIiwib25SZWNvbm5lY3QiLCJwcm90b2NvbCIsIndpbmRvdyIsImxvY2F0aW9uIiwid3NVcmwiLCJob3N0Iiwid2Vic29ja2V0IiwiV2ViU29ja2V0Iiwib25vcGVuIiwiZXZlbnQiLCJsb2ciLCJvbm1lc3NhZ2UiLCJkYXRhIiwiSlNPTiIsInBhcnNlIiwiaGFuZGxlTWVzc2FnZSIsImVycm9yIiwib25jbG9zZSIsInNldFRpbWVvdXQiLCJvbmVycm9yIiwiY2FsbGJhY2siLCJtZXNzYWdlSW5mbyIsInBhcnNlTWVzc2FnZSIsImlzVmFsaWQiLCJ0eXBlIiwicGFyc2VkIiwiZSIsInBheWxvYWQiLCJlbnZlbG9wZSIsIm1zZ1R5cGUiLCJ2YWxpZGF0ZVByb2dyZXNzTWVzc2FnZSIsImpvYklkIiwiam9iX2lkIiwicHJvZ3Jlc3MiLCJzdGF0dXMiLCJjdXJyZW50U3RlcCIsImN1cnJlbnRfc3RlcCIsInRvdGFsU3RlcHMiLCJ0b3RhbF9zdGVwcyIsImV0YSIsInRpbWVzdGFtcCIsIkRhdGUiLCJub3ciLCJ2YWxpZGF0ZUNvbXBsZXRlTWVzc2FnZSIsInJlc3VsdElkIiwicmVzdWx0X2lkIiwicHJvbXB0IiwibmVnYXRpdmVQcm9tcHQiLCJuZWdhdGl2ZV9wcm9tcHQiLCJpbWFnZVVybCIsImltYWdlX3VybCIsInRodW1ibmFpbFVybCIsInRodW1ibmFpbF91cmwiLCJ3aWR0aCIsImhlaWdodCIsInN0ZXBzIiwiY2ZnU2NhbGUiLCJjZmdfc2NhbGUiLCJzZWVkIiwiYmF0Y2hDb3VudCIsImJhdGNoX2NvdW50IiwiYmF0Y2hTaXplIiwiYmF0Y2hfc2l6ZSIsImdlbmVyYXRpb25UaW1lIiwiZ2VuZXJhdGlvbl90aW1lIiwiZmlsZVNpemUiLCJmaWxlX3NpemUiLCJtb2RlbFVzZWQiLCJtb2RlbF91c2VkIiwidmFsaWRhdGVFcnJvck1lc3NhZ2UiLCJlcnJvckNvZGUiLCJlcnJvcl9jb2RlIiwiZGV0YWlscyIsInZhbGlkYXRlUXVldWVNZXNzYWdlIiwiam9icyIsInF1ZXVlTGVuZ3RoIiwicXVldWVfbGVuZ3RoIiwicHJvY2Vzc2luZ0NvdW50IiwicHJvY2Vzc2luZ19jb3VudCIsInZhbGlkYXRlU3lzdGVtTWVzc2FnZSIsIm1lbW9yeVVzYWdlIiwibWVtb3J5X3VzYWdlIiwiZ3B1VXNhZ2UiLCJncHVfdXNhZ2UiLCJhY3RpdmVXb3JrZXJzIiwiYWN0aXZlX3dvcmtlcnMiLCJpc05hTiIsIk51bWJlciIsIkFycmF5IiwiaXNBcnJheSIsInNlbmQiLCJtZXNzYWdlVHlwZSIsInJlYWR5U3RhdGUiLCJPUEVOIiwibWVzc2FnZSIsInN0cmluZ2lmeSIsInJlcXVlc3RKb2JTdGF0dXMiLCJyZXF1ZXN0UXVldWVTdGF0dXMiLCJyZXF1ZXN0U3lzdGVtU3RhdHVzIiwic3Vic2NyaWJlVG9Kb2IiLCJ1bnN1YnNjcmliZUZyb21Kb2IiLCJnZXRDb25uZWN0aW9uU3RhdHVzIiwicmVhZHkiLCJzdGF0dXNNYXAiLCJDT05ORUNUSU5HIiwiQ0xPU0lORyIsIkNMT1NFRCIsImNsb3NlIiwiY3JlYXRlQ29ubmVjdGlvbk1hbmFnZXIiLCJyZWNvbm5lY3RBdHRlbXB0cyIsIm1heFJlY29ubmVjdEF0dGVtcHRzIiwicmVjb25uZWN0RGVsYXkiLCJpc0Rlc3Ryb3llZCIsImNvbm5lY3QiLCJNYXRoIiwibWluIiwib25NYXhSZWNvbm5lY3RBdHRlbXB0cyIsInNlbmRNZXNzYWdlIiwiZ2V0U3RhdHVzIiwiZGlzY29ubmVjdCIsImRlc3Ryb3kiLCJnZXRXZWJTb2NrZXQiLCJpc0Nvbm5lY3RlZCIsImFyZ3MiLCJEZXZMb2dnZXIiLCJpbmZvIiwiY29uc29sZSIsIm1vZHVsZSIsImV4cG9ydHMiXSwic291cmNlcyI6WyJ3ZWJzb2NrZXQuanMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBHZW5lcmF0aW9uIFN0dWRpbyAtIFdlYlNvY2tldCBPcGVyYXRpb25zIE1vZHVsZVxuICogXG4gKiBIYW5kbGVzIHJlYWwtdGltZSBjb21tdW5pY2F0aW9uIHZpYSBXZWJTb2NrZXQgY29ubmVjdGlvbnMuXG4gKi9cblxuLyoqXG4gKiBXZWJTb2NrZXQgbWFuYWdlbWVudCBmb3IgcmVhbC10aW1lIGdlbmVyYXRpb24gdXBkYXRlc1xuICovXG5jb25zdCBnZW5lcmF0aW9uV2ViU29ja2V0ID0ge1xuICAgIC8qKlxuICAgICAqIEluaXRpYWxpemVzIFdlYlNvY2tldCBjb25uZWN0aW9uXG4gICAgICovXG4gICAgaW5pdChjYWxsYmFja3MgPSB7fSkge1xuICAgICAgICBjb25zdCB7XG4gICAgICAgICAgICBvbk9wZW4gPSAoKSA9PiB7fSxcbiAgICAgICAgICAgIG9uTWVzc2FnZSA9ICgpID0+IHt9LFxuICAgICAgICAgICAgb25DbG9zZSA9ICgpID0+IHt9LFxuICAgICAgICAgICAgb25FcnJvciA9ICgpID0+IHt9LFxuICAgICAgICAgICAgb25SZWNvbm5lY3QgPSAoKSA9PiB7fVxuICAgICAgICB9ID0gY2FsbGJhY2tzO1xuICAgICAgICBcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IHByb3RvY29sID0gd2luZG93LmxvY2F0aW9uLnByb3RvY29sID09PSAnaHR0cHM6JyA/ICd3c3M6JyA6ICd3czonO1xuICAgICAgICAgICAgY29uc3Qgd3NVcmwgPSBgJHtwcm90b2NvbH0vLyR7d2luZG93LmxvY2F0aW9uLmhvc3R9L3dzL2dlbmVyYXRpb25gO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBjb25zdCB3ZWJzb2NrZXQgPSBuZXcgV2ViU29ja2V0KHdzVXJsKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgd2Vic29ja2V0Lm9ub3BlbiA9IChldmVudCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMubG9nKCdXZWJTb2NrZXQgY29ubmVjdGVkIGZvciBnZW5lcmF0aW9uIHVwZGF0ZXMnKTtcbiAgICAgICAgICAgICAgICBvbk9wZW4oZXZlbnQpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgd2Vic29ja2V0Lm9ubWVzc2FnZSA9IChldmVudCkgPT4ge1xuICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGRhdGEgPSBKU09OLnBhcnNlKGV2ZW50LmRhdGEpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmhhbmRsZU1lc3NhZ2UoZGF0YSwgb25NZXNzYWdlKTtcbiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmxvZygnRmFpbGVkIHRvIHBhcnNlIFdlYlNvY2tldCBtZXNzYWdlOicsIGVycm9yKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgXG4gICAgICAgICAgICB3ZWJzb2NrZXQub25jbG9zZSA9IChldmVudCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMubG9nKCdXZWJTb2NrZXQgZGlzY29ubmVjdGVkLCBhdHRlbXB0aW5nIHJlY29ubmVjdGlvbi4uLicpO1xuICAgICAgICAgICAgICAgIG9uQ2xvc2UoZXZlbnQpO1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIC8vIEF0dGVtcHQgcmVjb25uZWN0aW9uIGFmdGVyIGRlbGF5XG4gICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMubG9nKCdBdHRlbXB0aW5nIFdlYlNvY2tldCByZWNvbm5lY3Rpb24uLi4nKTtcbiAgICAgICAgICAgICAgICAgICAgb25SZWNvbm5lY3QoKTtcbiAgICAgICAgICAgICAgICB9LCA1MDAwKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIHdlYnNvY2tldC5vbmVycm9yID0gKGVycm9yKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5sb2coJ1dlYlNvY2tldCBlcnJvcjonLCBlcnJvcik7XG4gICAgICAgICAgICAgICAgb25FcnJvcihlcnJvcik7XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgXG4gICAgICAgICAgICByZXR1cm4gd2Vic29ja2V0O1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgdGhpcy5sb2coJ0ZhaWxlZCB0byBpbml0aWFsaXplIFdlYlNvY2tldDonLCBlcnJvcik7XG4gICAgICAgICAgICBvbkVycm9yKGVycm9yKTtcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9XG4gICAgfSxcbiAgICBcbiAgICAvKipcbiAgICAgKiBIYW5kbGVzIGluY29taW5nIFdlYlNvY2tldCBtZXNzYWdlc1xuICAgICAqL1xuICAgIGhhbmRsZU1lc3NhZ2UoZGF0YSwgY2FsbGJhY2spIHtcbiAgICAgICAgaWYgKCFkYXRhIHx8IHR5cGVvZiBkYXRhICE9PSAnb2JqZWN0Jykge1xuICAgICAgICAgICAgdGhpcy5sb2coJ0ludmFsaWQgV2ViU29ja2V0IG1lc3NhZ2UgZm9ybWF0OicsIGRhdGEpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICBjb25zdCBtZXNzYWdlSW5mbyA9IHRoaXMucGFyc2VNZXNzYWdlKGRhdGEpO1xuICAgICAgICBcbiAgICAgICAgaWYgKG1lc3NhZ2VJbmZvLmlzVmFsaWQpIHtcbiAgICAgICAgICAgIGNhbGxiYWNrKG1lc3NhZ2VJbmZvKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMubG9nKCdVbmtub3duIFdlYlNvY2tldCBtZXNzYWdlIHR5cGU6JywgZGF0YS50eXBlKTtcbiAgICAgICAgfVxuICAgIH0sXG4gICAgXG4gICAgLyoqXG4gICAgICogUGFyc2VzIGFuZCB2YWxpZGF0ZXMgV2ViU29ja2V0IG1lc3NhZ2VzXG4gICAgICovXG4gICAgcGFyc2VNZXNzYWdlKGRhdGEpIHtcbiAgICAgICAgLy8gQWNjZXB0IGVpdGhlciBhIEpTT04gc3RyaW5nIChmcm9tIHRlc3RzKSBvciBhbiBhbHJlYWR5LXBhcnNlZCBvYmplY3RcbiAgICAgICAgbGV0IHBhcnNlZCA9IGRhdGE7XG4gICAgICAgIGlmICh0eXBlb2YgZGF0YSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgcGFyc2VkID0gSlNPTi5wYXJzZShkYXRhKTtcbiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4geyB0eXBlOiBudWxsLCBpc1ZhbGlkOiBmYWxzZSwgcGF5bG9hZDogbnVsbCB9O1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgLy8gU3VwcG9ydCBtZXNzYWdlcyB0aGF0IG1heSBiZSB3cmFwcGVkIGluIGEgYHBheWxvYWRgIGVudmVsb3BlXG4gICAgICAgIGNvbnN0IGVudmVsb3BlID0gcGFyc2VkLnBheWxvYWQgJiYgdHlwZW9mIHBhcnNlZC5wYXlsb2FkID09PSAnb2JqZWN0JyA/IHBhcnNlZC5wYXlsb2FkIDogcGFyc2VkO1xuXG4gICAgICAgIGNvbnN0IG1zZ1R5cGUgPSBwYXJzZWQ/LnR5cGUgfHwgZW52ZWxvcGU/LnR5cGUgfHwgbnVsbDtcblxuICAgICAgICBjb25zdCBtZXNzYWdlSW5mbyA9IHtcbiAgICAgICAgICAgIHR5cGU6IG1zZ1R5cGUsXG4gICAgICAgICAgICBpc1ZhbGlkOiBmYWxzZSxcbiAgICAgICAgICAgIHBheWxvYWQ6IG51bGxcbiAgICAgICAgfTtcblxuICAgIHN3aXRjaCAobXNnVHlwZSkge1xuICAgICAgICAgICAgY2FzZSAnZ2VuZXJhdGlvbl9wcm9ncmVzcyc6XG4gICAgICAgICAgICBjYXNlICdwcm9ncmVzcyc6IC8vIGJhY2t3YXJkcy1jb21wYXRpYmxlIGFsaWFzIHVzZWQgaW4gc29tZSB0ZXN0cy9jbGllbnRzXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMudmFsaWRhdGVQcm9ncmVzc01lc3NhZ2UoZW52ZWxvcGUpKSB7XG4gICAgICAgICAgICAgICAgICAgIG1lc3NhZ2VJbmZvLmlzVmFsaWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICBtZXNzYWdlSW5mby5wYXlsb2FkID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgam9iSWQ6IGVudmVsb3BlLmpvYl9pZCB8fCBlbnZlbG9wZS5qb2JJZCxcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb2dyZXNzOiBlbnZlbG9wZS5wcm9ncmVzcyxcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXR1czogZW52ZWxvcGUuc3RhdHVzLFxuICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudFN0ZXA6IGVudmVsb3BlLmN1cnJlbnRfc3RlcCB8fCBlbnZlbG9wZS5jdXJyZW50U3RlcCxcbiAgICAgICAgICAgICAgICAgICAgICAgIHRvdGFsU3RlcHM6IGVudmVsb3BlLnRvdGFsX3N0ZXBzIHx8IGVudmVsb3BlLnRvdGFsU3RlcHMsXG4gICAgICAgICAgICAgICAgICAgICAgICBldGE6IGVudmVsb3BlLmV0YSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVzdGFtcDogZW52ZWxvcGUudGltZXN0YW1wIHx8IERhdGUubm93KClcbiAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICBjYXNlICdnZW5lcmF0aW9uX2NvbXBsZXRlJzpcbiAgICAgICAgICAgIGNhc2UgJ2NvbXBsZXRlJzpcbiAgICAgICAgICAgICAgICBpZiAodGhpcy52YWxpZGF0ZUNvbXBsZXRlTWVzc2FnZShlbnZlbG9wZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZUluZm8uaXNWYWxpZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIG1lc3NhZ2VJbmZvLnBheWxvYWQgPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBqb2JJZDogZW52ZWxvcGUuam9iX2lkIHx8IGVudmVsb3BlLmpvYklkLFxuICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0SWQ6IGVudmVsb3BlLnJlc3VsdF9pZCB8fCBlbnZlbG9wZS5yZXN1bHRJZCxcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb21wdDogZW52ZWxvcGUucHJvbXB0LFxuICAgICAgICAgICAgICAgICAgICAgICAgbmVnYXRpdmVQcm9tcHQ6IGVudmVsb3BlLm5lZ2F0aXZlX3Byb21wdCB8fCBlbnZlbG9wZS5uZWdhdGl2ZVByb21wdCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGltYWdlVXJsOiBlbnZlbG9wZS5pbWFnZV91cmwgfHwgZW52ZWxvcGUuaW1hZ2VVcmwsXG4gICAgICAgICAgICAgICAgICAgICAgICB0aHVtYm5haWxVcmw6IGVudmVsb3BlLnRodW1ibmFpbF91cmwgfHwgZW52ZWxvcGUudGh1bWJuYWlsVXJsLFxuICAgICAgICAgICAgICAgICAgICAgICAgd2lkdGg6IGVudmVsb3BlLndpZHRoLFxuICAgICAgICAgICAgICAgICAgICAgICAgaGVpZ2h0OiBlbnZlbG9wZS5oZWlnaHQsXG4gICAgICAgICAgICAgICAgICAgICAgICBzdGVwczogZW52ZWxvcGUuc3RlcHMsXG4gICAgICAgICAgICAgICAgICAgICAgICBjZmdTY2FsZTogZW52ZWxvcGUuY2ZnX3NjYWxlIHx8IGVudmVsb3BlLmNmZ1NjYWxlLFxuICAgICAgICAgICAgICAgICAgICAgICAgc2VlZDogZW52ZWxvcGUuc2VlZCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGJhdGNoQ291bnQ6IGVudmVsb3BlLmJhdGNoX2NvdW50IHx8IGVudmVsb3BlLmJhdGNoQ291bnQsXG4gICAgICAgICAgICAgICAgICAgICAgICBiYXRjaFNpemU6IGVudmVsb3BlLmJhdGNoX3NpemUgfHwgZW52ZWxvcGUuYmF0Y2hTaXplLFxuICAgICAgICAgICAgICAgICAgICAgICAgZ2VuZXJhdGlvblRpbWU6IGVudmVsb3BlLmdlbmVyYXRpb25fdGltZSB8fCBlbnZlbG9wZS5nZW5lcmF0aW9uVGltZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGZpbGVTaXplOiBlbnZlbG9wZS5maWxlX3NpemUgfHwgZW52ZWxvcGUuZmlsZVNpemUsXG4gICAgICAgICAgICAgICAgICAgICAgICBtb2RlbFVzZWQ6IGVudmVsb3BlLm1vZGVsX3VzZWQgfHwgZW52ZWxvcGUubW9kZWxVc2VkLFxuICAgICAgICAgICAgICAgICAgICAgICAgdGltZXN0YW1wOiBlbnZlbG9wZS50aW1lc3RhbXAgfHwgRGF0ZS5ub3coKVxuICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIGNhc2UgJ2dlbmVyYXRpb25fZXJyb3InOlxuICAgICAgICAgICAgY2FzZSAnZXJyb3InOlxuICAgICAgICAgICAgICAgIGlmICh0aGlzLnZhbGlkYXRlRXJyb3JNZXNzYWdlKGVudmVsb3BlKSkge1xuICAgICAgICAgICAgICAgICAgICBtZXNzYWdlSW5mby5pc1ZhbGlkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZUluZm8ucGF5bG9hZCA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGpvYklkOiBlbnZlbG9wZS5qb2JfaWQgfHwgZW52ZWxvcGUuam9iSWQsXG4gICAgICAgICAgICAgICAgICAgICAgICBlcnJvcjogZW52ZWxvcGUuZXJyb3IsXG4gICAgICAgICAgICAgICAgICAgICAgICBlcnJvckNvZGU6IGVudmVsb3BlLmVycm9yX2NvZGUgfHwgZW52ZWxvcGUuZXJyb3JDb2RlLFxuICAgICAgICAgICAgICAgICAgICAgICAgZGV0YWlsczogZW52ZWxvcGUuZGV0YWlscyxcbiAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVzdGFtcDogZW52ZWxvcGUudGltZXN0YW1wIHx8IERhdGUubm93KClcbiAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICBjYXNlICdxdWV1ZV91cGRhdGUnOlxuICAgICAgICAgICAgY2FzZSAncXVldWUnOlxuICAgICAgICAgICAgICAgIGlmICh0aGlzLnZhbGlkYXRlUXVldWVNZXNzYWdlKGVudmVsb3BlKSkge1xuICAgICAgICAgICAgICAgICAgICBtZXNzYWdlSW5mby5pc1ZhbGlkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZUluZm8ucGF5bG9hZCA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGpvYnM6IGVudmVsb3BlLmpvYnMsXG4gICAgICAgICAgICAgICAgICAgICAgICBxdWV1ZUxlbmd0aDogZW52ZWxvcGUucXVldWVfbGVuZ3RoIHx8IGVudmVsb3BlLnF1ZXVlTGVuZ3RoLFxuICAgICAgICAgICAgICAgICAgICAgICAgcHJvY2Vzc2luZ0NvdW50OiBlbnZlbG9wZS5wcm9jZXNzaW5nX2NvdW50IHx8IGVudmVsb3BlLnByb2Nlc3NpbmdDb3VudCxcbiAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVzdGFtcDogZW52ZWxvcGUudGltZXN0YW1wIHx8IERhdGUubm93KClcbiAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICBjYXNlICdzeXN0ZW1fc3RhdHVzJzpcbiAgICAgICAgICAgIGNhc2UgJ3N0YXR1cyc6XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMudmFsaWRhdGVTeXN0ZW1NZXNzYWdlKGVudmVsb3BlKSkge1xuICAgICAgICAgICAgICAgICAgICBtZXNzYWdlSW5mby5pc1ZhbGlkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZUluZm8ucGF5bG9hZCA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXR1czogZW52ZWxvcGUuc3RhdHVzLFxuICAgICAgICAgICAgICAgICAgICAgICAgbWVtb3J5VXNhZ2U6IGVudmVsb3BlLm1lbW9yeV91c2FnZSB8fCBlbnZlbG9wZS5tZW1vcnlVc2FnZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGdwdVVzYWdlOiBlbnZlbG9wZS5ncHVfdXNhZ2UgfHwgZW52ZWxvcGUuZ3B1VXNhZ2UsXG4gICAgICAgICAgICAgICAgICAgICAgICBxdWV1ZUxlbmd0aDogZW52ZWxvcGUucXVldWVfbGVuZ3RoIHx8IGVudmVsb3BlLnF1ZXVlTGVuZ3RoLFxuICAgICAgICAgICAgICAgICAgICAgICAgYWN0aXZlV29ya2VyczogZW52ZWxvcGUuYWN0aXZlX3dvcmtlcnMgfHwgZW52ZWxvcGUuYWN0aXZlV29ya2VycyxcbiAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVzdGFtcDogZW52ZWxvcGUudGltZXN0YW1wIHx8IERhdGUubm93KClcbiAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICAgIHRoaXMubG9nKCdVbmtub3duIG1lc3NhZ2UgdHlwZTonLCBtc2dUeXBlKTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICByZXR1cm4gbWVzc2FnZUluZm87XG4gICAgfSxcbiAgICBcbiAgICAvKipcbiAgICAgKiBWYWxpZGF0ZXMgcHJvZ3Jlc3MgbWVzc2FnZSBmb3JtYXRcbiAgICAgKi9cbiAgICB2YWxpZGF0ZVByb2dyZXNzTWVzc2FnZShkYXRhKSB7XG4gICAgcmV0dXJuIChkYXRhLmpvYl9pZCB8fCBkYXRhLmpvYklkKSAmJiBcbiAgICAgICAgICAgKHR5cGVvZiBkYXRhLnByb2dyZXNzID09PSAnbnVtYmVyJyB8fCAoIWlzTmFOKE51bWJlcihkYXRhLnByb2dyZXNzKSkpKSAmJiBcbiAgICAgICAgICAgTnVtYmVyKGRhdGEucHJvZ3Jlc3MpID49IDAgJiYgXG4gICAgICAgICAgIE51bWJlcihkYXRhLnByb2dyZXNzKSA8PSAxMDA7XG4gICAgfSxcbiAgICBcbiAgICAvKipcbiAgICAgKiBWYWxpZGF0ZXMgY29tcGxldGlvbiBtZXNzYWdlIGZvcm1hdFxuICAgICAqL1xuICAgIHZhbGlkYXRlQ29tcGxldGVNZXNzYWdlKGRhdGEpIHtcbiAgICByZXR1cm4gKGRhdGEuam9iX2lkIHx8IGRhdGEuam9iSWQpICYmIFxuICAgICAgICAgICAoZGF0YS5yZXN1bHRfaWQgfHwgZGF0YS5yZXN1bHRJZCkgJiYgXG4gICAgICAgICAgIChkYXRhLmltYWdlX3VybCB8fCBkYXRhLmltYWdlVXJsKSAmJlxuICAgICAgICAgICBkYXRhLnByb21wdDtcbiAgICB9LFxuICAgIFxuICAgIC8qKlxuICAgICAqIFZhbGlkYXRlcyBlcnJvciBtZXNzYWdlIGZvcm1hdFxuICAgICAqL1xuICAgIHZhbGlkYXRlRXJyb3JNZXNzYWdlKGRhdGEpIHtcbiAgICByZXR1cm4gKGRhdGEuam9iX2lkIHx8IGRhdGEuam9iSWQpICYmIGRhdGEuZXJyb3I7XG4gICAgfSxcbiAgICBcbiAgICAvKipcbiAgICAgKiBWYWxpZGF0ZXMgcXVldWUgbWVzc2FnZSBmb3JtYXRcbiAgICAgKi9cbiAgICB2YWxpZGF0ZVF1ZXVlTWVzc2FnZShkYXRhKSB7XG4gICAgcmV0dXJuIEFycmF5LmlzQXJyYXkoZGF0YS5qb2JzKSAmJiBcbiAgICAgICAgICAgdHlwZW9mIChkYXRhLnF1ZXVlX2xlbmd0aCB8fCBkYXRhLnF1ZXVlTGVuZ3RoKSA9PT0gJ251bWJlcic7XG4gICAgfSxcbiAgICBcbiAgICAvKipcbiAgICAgKiBWYWxpZGF0ZXMgc3lzdGVtIHN0YXR1cyBtZXNzYWdlIGZvcm1hdFxuICAgICAqL1xuICAgIHZhbGlkYXRlU3lzdGVtTWVzc2FnZShkYXRhKSB7XG4gICAgcmV0dXJuIGRhdGEuc3RhdHVzICYmIHR5cGVvZiBkYXRhLnN0YXR1cyA9PT0gJ29iamVjdCc7XG4gICAgfSxcbiAgICBcbiAgICAvKipcbiAgICAgKiBTZW5kcyBhIG1lc3NhZ2UgdGhyb3VnaCBXZWJTb2NrZXRcbiAgICAgKi9cbiAgICBzZW5kKHdlYnNvY2tldCwgbWVzc2FnZVR5cGUsIHBheWxvYWQpIHtcbiAgICAgICAgaWYgKCF3ZWJzb2NrZXQgfHwgd2Vic29ja2V0LnJlYWR5U3RhdGUgIT09IFdlYlNvY2tldC5PUEVOKSB7XG4gICAgICAgICAgICB0aGlzLmxvZygnV2ViU29ja2V0IG5vdCBhdmFpbGFibGUgZm9yIHNlbmRpbmcgbWVzc2FnZScpO1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgbWVzc2FnZSA9IHtcbiAgICAgICAgICAgICAgICB0eXBlOiBtZXNzYWdlVHlwZSxcbiAgICAgICAgICAgICAgICB0aW1lc3RhbXA6IERhdGUubm93KCksXG4gICAgICAgICAgICAgICAgLi4ucGF5bG9hZFxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgd2Vic29ja2V0LnNlbmQoSlNPTi5zdHJpbmdpZnkobWVzc2FnZSkpO1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICB0aGlzLmxvZygnRmFpbGVkIHRvIHNlbmQgV2ViU29ja2V0IG1lc3NhZ2U6JywgZXJyb3IpO1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gICAgfSxcbiAgICBcbiAgICAvKipcbiAgICAgKiBSZXF1ZXN0cyBqb2Igc3RhdHVzIHVwZGF0ZVxuICAgICAqL1xuICAgIHJlcXVlc3RKb2JTdGF0dXMod2Vic29ja2V0LCBqb2JJZCkge1xuICAgICAgICByZXR1cm4gdGhpcy5zZW5kKHdlYnNvY2tldCwgJ3JlcXVlc3Rfam9iX3N0YXR1cycsIHsgam9iX2lkOiBqb2JJZCB9KTtcbiAgICB9LFxuICAgIFxuICAgIC8qKlxuICAgICAqIFJlcXVlc3RzIHF1ZXVlIHN0YXR1c1xuICAgICAqL1xuICAgIHJlcXVlc3RRdWV1ZVN0YXR1cyh3ZWJzb2NrZXQpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc2VuZCh3ZWJzb2NrZXQsICdyZXF1ZXN0X3F1ZXVlX3N0YXR1cycsIHt9KTtcbiAgICB9LFxuICAgIFxuICAgIC8qKlxuICAgICAqIFJlcXVlc3RzIHN5c3RlbSBzdGF0dXNcbiAgICAgKi9cbiAgICByZXF1ZXN0U3lzdGVtU3RhdHVzKHdlYnNvY2tldCkge1xuICAgICAgICByZXR1cm4gdGhpcy5zZW5kKHdlYnNvY2tldCwgJ3JlcXVlc3Rfc3lzdGVtX3N0YXR1cycsIHt9KTtcbiAgICB9LFxuICAgIFxuICAgIC8qKlxuICAgICAqIFN1YnNjcmliZXMgdG8gam9iIHVwZGF0ZXNcbiAgICAgKi9cbiAgICBzdWJzY3JpYmVUb0pvYih3ZWJzb2NrZXQsIGpvYklkKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnNlbmQod2Vic29ja2V0LCAnc3Vic2NyaWJlX2pvYicsIHsgam9iX2lkOiBqb2JJZCB9KTtcbiAgICB9LFxuICAgIFxuICAgIC8qKlxuICAgICAqIFVuc3Vic2NyaWJlcyBmcm9tIGpvYiB1cGRhdGVzXG4gICAgICovXG4gICAgdW5zdWJzY3JpYmVGcm9tSm9iKHdlYnNvY2tldCwgam9iSWQpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc2VuZCh3ZWJzb2NrZXQsICd1bnN1YnNjcmliZV9qb2InLCB7IGpvYl9pZDogam9iSWQgfSk7XG4gICAgfSxcbiAgICBcbiAgICAvKipcbiAgICAgKiBHZXRzIFdlYlNvY2tldCBjb25uZWN0aW9uIHN0YXR1c1xuICAgICAqL1xuICAgIGdldENvbm5lY3Rpb25TdGF0dXMod2Vic29ja2V0KSB7XG4gICAgICAgIGlmICghd2Vic29ja2V0KSB7XG4gICAgICAgICAgICByZXR1cm4geyBzdGF0dXM6ICdub3RfaW5pdGlhbGl6ZWQnLCByZWFkeTogZmFsc2UgfTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgY29uc3Qgc3RhdHVzTWFwID0ge1xuICAgICAgICAgICAgW1dlYlNvY2tldC5DT05ORUNUSU5HXTogeyBzdGF0dXM6ICdjb25uZWN0aW5nJywgcmVhZHk6IGZhbHNlIH0sXG4gICAgICAgICAgICBbV2ViU29ja2V0Lk9QRU5dOiB7IHN0YXR1czogJ2Nvbm5lY3RlZCcsIHJlYWR5OiB0cnVlIH0sXG4gICAgICAgICAgICBbV2ViU29ja2V0LkNMT1NJTkddOiB7IHN0YXR1czogJ2Nsb3NpbmcnLCByZWFkeTogZmFsc2UgfSxcbiAgICAgICAgICAgIFtXZWJTb2NrZXQuQ0xPU0VEXTogeyBzdGF0dXM6ICdjbG9zZWQnLCByZWFkeTogZmFsc2UgfVxuICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgcmV0dXJuIHN0YXR1c01hcFt3ZWJzb2NrZXQucmVhZHlTdGF0ZV0gfHwgeyBzdGF0dXM6ICd1bmtub3duJywgcmVhZHk6IGZhbHNlIH07XG4gICAgfSxcbiAgICBcbiAgICAvKipcbiAgICAgKiBDbG9zZXMgV2ViU29ja2V0IGNvbm5lY3Rpb24gZ3JhY2VmdWxseVxuICAgICAqL1xuICAgIGNsb3NlKHdlYnNvY2tldCkge1xuICAgICAgICBpZiAod2Vic29ja2V0ICYmIHdlYnNvY2tldC5yZWFkeVN0YXRlID09PSBXZWJTb2NrZXQuT1BFTikge1xuICAgICAgICAgICAgd2Vic29ja2V0LmNsb3NlKDEwMDAsICdDb21wb25lbnQgY2xlYW51cCcpO1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH0sXG4gICAgXG4gICAgLyoqXG4gICAgICogQ3JlYXRlcyBXZWJTb2NrZXQgY29ubmVjdGlvbiBtYW5hZ2VyXG4gICAgICovXG4gICAgY3JlYXRlQ29ubmVjdGlvbk1hbmFnZXIoY2FsbGJhY2tzID0ge30pIHtcbiAgICAgICAgbGV0IHdlYnNvY2tldCA9IG51bGw7XG4gICAgICAgIGxldCByZWNvbm5lY3RBdHRlbXB0cyA9IDA7XG4gICAgICAgIGNvbnN0IG1heFJlY29ubmVjdEF0dGVtcHRzID0gNTtcbiAgICAgICAgbGV0IHJlY29ubmVjdERlbGF5ID0gMTAwMDsgLy8gU3RhcnQgd2l0aCAxIHNlY29uZFxuICAgICAgICBsZXQgaXNEZXN0cm95ZWQgPSBmYWxzZTtcbiAgICAgICAgXG4gICAgICAgIGNvbnN0IGNvbm5lY3QgPSAoKSA9PiB7XG4gICAgICAgICAgICBpZiAoaXNEZXN0cm95ZWQpIHJldHVybiBudWxsO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICB3ZWJzb2NrZXQgPSB0aGlzLmluaXQoe1xuICAgICAgICAgICAgICAgIG9uT3BlbjogKGV2ZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJlY29ubmVjdEF0dGVtcHRzID0gMDtcbiAgICAgICAgICAgICAgICAgICAgcmVjb25uZWN0RGVsYXkgPSAxMDAwO1xuICAgICAgICAgICAgICAgICAgICBpZiAoY2FsbGJhY2tzLm9uT3BlbikgY2FsbGJhY2tzLm9uT3BlbihldmVudCk7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBvbk1lc3NhZ2U6IChtZXNzYWdlSW5mbykgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZiAoY2FsbGJhY2tzLm9uTWVzc2FnZSkgY2FsbGJhY2tzLm9uTWVzc2FnZShtZXNzYWdlSW5mbyk7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBvbkNsb3NlOiAoZXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrcy5vbkNsb3NlKSBjYWxsYmFja3Mub25DbG9zZShldmVudCk7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBvbkVycm9yOiAoZXJyb3IpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrcy5vbkVycm9yKSBjYWxsYmFja3Mub25FcnJvcihlcnJvcik7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBvblJlY29ubmVjdDogKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZiAoaXNEZXN0cm95ZWQpIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIGlmIChyZWNvbm5lY3RBdHRlbXB0cyA8IG1heFJlY29ubmVjdEF0dGVtcHRzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZWNvbm5lY3RBdHRlbXB0cysrO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVjb25uZWN0RGVsYXkgPSBNYXRoLm1pbihyZWNvbm5lY3REZWxheSAqIDIsIDMwMDAwKTsgLy8gQ2FwIGF0IDMwIHNlY29uZHNcbiAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFpc0Rlc3Ryb3llZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxvZyhgUmVjb25uZWN0aW9uIGF0dGVtcHQgJHtyZWNvbm5lY3RBdHRlbXB0c30vJHttYXhSZWNvbm5lY3RBdHRlbXB0c31gKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29ubmVjdCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH0sIHJlY29ubmVjdERlbGF5KTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubG9nKCdNYXggcmVjb25uZWN0aW9uIGF0dGVtcHRzIHJlYWNoZWQnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjYWxsYmFja3Mub25NYXhSZWNvbm5lY3RBdHRlbXB0cykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrcy5vbk1heFJlY29ubmVjdEF0dGVtcHRzKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgcmV0dXJuIHdlYnNvY2tldDtcbiAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBjb25uZWN0LFxuICAgICAgICAgICAgLy8gUHJpbWFyeSBzZW5kIG1ldGhvZFxuICAgICAgICAgICAgc2VuZDogKG1lc3NhZ2VUeXBlLCBwYXlsb2FkKSA9PiB0aGlzLnNlbmQod2Vic29ja2V0LCBtZXNzYWdlVHlwZSwgcGF5bG9hZCksXG4gICAgICAgICAgICAvLyBCYWNrd2FyZHMtY29tcGF0aWJsZSBhbGlhc1xuICAgICAgICAgICAgc2VuZE1lc3NhZ2U6IChtZXNzYWdlVHlwZSwgcGF5bG9hZCkgPT4gdGhpcy5zZW5kKHdlYnNvY2tldCwgbWVzc2FnZVR5cGUsIHBheWxvYWQpLFxuICAgICAgICAgICAgZ2V0U3RhdHVzOiAoKSA9PiB0aGlzLmdldENvbm5lY3Rpb25TdGF0dXMod2Vic29ja2V0KSxcbiAgICAgICAgICAgIC8vIFByaW1hcnkgY2xvc2UgbWV0aG9kXG4gICAgICAgICAgICBjbG9zZTogKCkgPT4gdGhpcy5jbG9zZSh3ZWJzb2NrZXQpLFxuICAgICAgICAgICAgLy8gQmFja3dhcmRzLWNvbXBhdGlibGUgYWxpYXNcbiAgICAgICAgICAgIGRpc2Nvbm5lY3Q6ICgpID0+IHRoaXMuY2xvc2Uod2Vic29ja2V0KSxcbiAgICAgICAgICAgIGRlc3Ryb3k6ICgpID0+IHtcbiAgICAgICAgICAgICAgICBpc0Rlc3Ryb3llZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgdGhpcy5jbG9zZSh3ZWJzb2NrZXQpO1xuICAgICAgICAgICAgICAgIHdlYnNvY2tldCA9IG51bGw7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgZ2V0V2ViU29ja2V0OiAoKSA9PiB3ZWJzb2NrZXQsXG4gICAgICAgICAgICBpc0Nvbm5lY3RlZDogKCkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IHN0YXR1cyA9IHRoaXMuZ2V0Q29ubmVjdGlvblN0YXR1cyh3ZWJzb2NrZXQpO1xuICAgICAgICAgICAgICAgIHJldHVybiBzdGF0dXMucmVhZHk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgfSxcbiAgICBcbiAgICAvKipcbiAgICAgKiBMb2dnaW5nIHV0aWxpdHlcbiAgICAgKi9cbiAgICBsb2cobWVzc2FnZSwgLi4uYXJncykge1xuICAgICAgICBpZiAod2luZG93LkRldkxvZ2dlcikge1xuICAgICAgICAgICAgd2luZG93LkRldkxvZ2dlci5pbmZvKGBbR2VuZXJhdGlvbldlYlNvY2tldF0gJHttZXNzYWdlfWAsIC4uLmFyZ3MpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWNvbnNvbGVcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbR2VuZXJhdGlvbldlYlNvY2tldF0gJHttZXNzYWdlfWAsIC4uLmFyZ3MpO1xuICAgICAgICB9XG4gICAgfVxufTtcblxuLy8gRXhwb3J0IGZvciB1c2UgaW4gb3RoZXIgbW9kdWxlc1xuaWYgKHR5cGVvZiBtb2R1bGUgIT09ICd1bmRlZmluZWQnICYmIG1vZHVsZS5leHBvcnRzKSB7XG4gICAgbW9kdWxlLmV4cG9ydHMgPSB7IGdlbmVyYXRpb25XZWJTb2NrZXQgfTtcbn0gZWxzZSBpZiAodHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICB3aW5kb3cuZ2VuZXJhdGlvbldlYlNvY2tldCA9IGdlbmVyYXRpb25XZWJTb2NrZXQ7XG59XG4iXSwibWFwcGluZ3Mi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RUFBRXFGLFdBQVcsRUFBRWhFLE9BQU8sQ0FBQztNQUMxRTtNQUNBMEYsV0FBVyxFQUFFQSxDQUFDMUIsV0FBVyxFQUFFaEUsT0FBTyxLQUFLLElBQUksQ0FBQytELElBQUksQ0FBQ3BGLFNBQVMsRUFBRXFGLFdBQVcsRUFBRWhFLE9BQU8sQ0FBQztNQUNqRjJGLFNBQVMsRUFBRUEsQ0FBQSxLQUFNLElBQUksQ0FBQ2pCLG1CQUFtQixDQUFDL0YsU0FBUyxDQUFDO01BQ3BEO01BQ0FxRyxLQUFLLEVBQUVBLENBQUEsS0FBTSxJQUFJLENBQUNBLEtBQUssQ0FBQ3JHLFNBQVMsQ0FBQztNQUNsQztNQUNBaUgsVUFBVSxFQUFFQSxDQUFBLEtBQU0sSUFBSSxDQUFDWixLQUFLLENBQUNyRyxTQUFTLENBQUM7TUFDdkNrSCxPQUFPLEVBQUVBLENBQUEsS0FBTTtRQUNYUixXQUFXLEdBQUcsSUFBSTtRQUNsQixJQUFJLENBQUNMLEtBQUssQ0FBQ3JHLFNBQVMsQ0FBQztRQUNyQkEsU0FBUyxHQUFHLElBQUk7TUFDcEIsQ0FBQztNQUNEbUgsWUFBWSxFQUFFQSxDQUFBLEtBQU1uSCxTQUFTO01BQzdCb0gsV0FBVyxFQUFFQSxDQUFBLEtBQU07UUFDZixNQUFNeEYsTUFBTSxHQUFHLElBQUksQ0FBQ21FLG1CQUFtQixDQUFDL0YsU0FBUyxDQUFDO1FBQ2xELE9BQU80QixNQUFNLENBQUNvRSxLQUFLO01BQ3ZCO0lBQ0osQ0FBQztFQUNMLENBQUM7RUFFRDtBQUNKO0FBQ0E7RUFDSTVGLEdBQUdBLENBQUNvRixPQUFPLEVBQUUsR0FBRzZCLElBQUksRUFBRTtJQUNsQixJQUFJekgsTUFBTSxDQUFDMEgsU0FBUyxFQUFFO01BQ2xCMUgsTUFBTSxDQUFDMEgsU0FBUyxDQUFDQyxJQUFJLENBQUMseUJBQXlCL0IsT0FBTyxFQUFFLEVBQUUsR0FBRzZCLElBQUksQ0FBQztJQUN0RSxDQUFDLE1BQU07TUFDSDtNQUNBRyxPQUFPLENBQUNwSCxHQUFHLENBQUMseUJBQXlCb0YsT0FBTyxFQUFFLEVBQUUsR0FBRzZCLElBQUksQ0FBQztJQUM1RDtFQUNKO0FBQ0osQ0FBQzs7QUFFRDtBQUNBLElBQUksT0FBT0ksTUFBTSxLQUFLLFdBQVcsSUFBSUEsTUFBTSxDQUFDQyxPQUFPLEVBQUU7RUFDakRELE1BQU0sQ0FBQ0MsT0FBTyxHQUFHO0lBQUV2STtFQUFvQixDQUFDO0FBQzVDLENBQUMsTUFBTSxJQUFJLE9BQU9TLE1BQU0sS0FBSyxXQUFXLEVBQUU7RUFDdENBLE1BQU0sQ0FBQ1QsbUJBQW1CLEdBQUdBLG1CQUFtQjtBQUNwRCIsImlnbm9yZUxpc3QiOltdfQ==