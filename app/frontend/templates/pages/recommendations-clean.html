{% extends "base.html" %}

{% block title %}AI Recommendations - LoRA Manager{% endblock %}

{% block content %}
<div x-data="recommendationsData()" x-init="init()" class="recommendations-page-container">
    <!-- Page Header -->
    <div class="page-header">
        <h1 class="page-title">AI-Powered Recommendations</h1>
        <p class="page-subtitle">Discover LoRAs using advanced similarity matching and prompt-based recommendations.</p>
    </div>

    <!-- Tab Navigation -->
    <div class="tabs-container">
        <nav class="tabs-nav">
            <button 
                @click="activeTab = 'similarity'"
                :class="activeTab === 'similarity' ? 'active' : ''"
                class="tab-btn"
            >
                <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                </svg>
                Similarity Explorer
            </button>
            <button 
                @click="activeTab = 'prompt'"
                :class="activeTab === 'prompt' ? 'active' : ''"
                class="tab-btn"
            >
                <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                </svg>
                Prompt-Based
            </button>
            <button 
                @click="activeTab = 'status'"
                :class="activeTab === 'status' ? 'active' : ''"
                class="tab-btn"
            >
                <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                </svg>
                Embedding Status
            </button>
        </nav>
    </div>

    <!-- Similarity Explorer Tab -->
    <div x-show="activeTab === 'similarity'" x-transition class="tab-content">
        <!-- Controls -->
        <div class="card">
            <h3 class="card-title">Find Similar LoRAs</h3>
            
            <!-- LoRA Selection -->
            <div class="form-group">
                <label class="form-label">Select Base LoRA</label>
                <select 
                    x-model="selectedLoraId" 
                    @change="selectedLora = availableLoras.find(l => l.id === selectedLoraId)"
                    class="form-select"
                >
                    <option value="">Choose a LoRA...</option>
                    <template x-for="lora in availableLoras" :key="lora.id">
                        <option :value="lora.id" x-text="lora.name"></option>
                    </template>
                </select>
            </div>

            <!-- Similarity Weights -->
            <div class="weight-sliders-container">
                <!-- Semantic Weight -->
                <div class="slider-group">
                    <label class="form-label">
                        Semantic Weight
                        <span class="slider-value text-blue-600" x-text="weights.semantic"></span>
                    </label>
                    <input 
                        type="range" 
                        x-model.number="weights.semantic" 
                        min="0" 
                        max="1" 
                        step="0.1"
                        @input="normalizeWeights('semantic')"
                        class="form-range slider-blue"
                    />
                </div>

                <!-- Artistic Weight -->
                <div class="slider-group">
                    <label class="form-label">
                        Artistic Weight
                        <span class="slider-value text-purple-600" x-text="weights.artistic"></span>
                    </label>
                    <input 
                        type="range" 
                        x-model.number="weights.artistic" 
                        min="0" 
                        max="1" 
                        step="0.1"
                        @input="normalizeWeights('artistic')"
                        class="form-range slider-purple"
                    />
                </div>

                <!-- Technical Weight -->
                <div class="slider-group">
                    <label class="form-label">
                        Technical Weight
                        <span class="slider-value text-orange-600" x-text="weights.technical"></span>
                    </label>
                    <input 
                        type="range" 
                        x-model.number="weights.technical" 
                        min="0" 
                        max="1" 
                        step="0.1"
                        @input="normalizeWeights('technical')"
                        class="form-range slider-orange"
                    />
                </div>
            </div>

            <!-- Additional Settings -->
            <div class="additional-settings-container">
                <div class="slider-group">
                    <label class="form-label">
                        Number of Results: <span x-text="similarityLimit"></span>
                    </label>
                    <input 
                        type="range" 
                        x-model.number="similarityLimit" 
                        min="5" 
                        max="50" 
                        step="5"
                        class="form-range"
                    />
                </div>
                <div class="slider-group">
                    <label class="form-label">
                        Similarity Threshold: <span x-text="similarityThreshold"></span>
                    </label>
                    <input 
                        type="range" 
                        x-model.number="similarityThreshold" 
                        min="0.05" 
                        max="0.5" 
                        step="0.05"
                        class="form-range"
                    />
                </div>
            </div>

            <!-- Search Button -->
            <button 
                @click="findSimilar()" 
                :disabled="!selectedLoraId"
                class="btn btn-primary w-full"
                :class="{ 'btn-disabled': !selectedLoraId }"
            >
                <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
                Find Similar LoRAs
            </button>
        </div>

        <!-- Similarity Results -->
        <div x-show="selectedLoraId" x-transition>
            <div 
                id="similarity-results"
                hx-post="/api/htmx/recommendations/similar"
                hx-trigger="similarity-search from:body"
                hx-include="[data-similarity]"
                class="results-container"
            >
                <!-- Results will be loaded here -->
                <div class="placeholder-message">
                    <svg class="placeholder-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                    </svg>
                    <p class="placeholder-text">Select a LoRA to see recommendations</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Prompt-Based Recommendations Tab -->
    <div x-show="activeTab === 'prompt'" x-transition class="tab-content">
        <!-- Controls -->
        <div class="card">
            <h3 class="card-title">Prompt-Based Recommendations</h3>
            
            <!-- Prompt Input -->
            <div class="form-group">
                <label class="form-label">Enter Your Prompt</label>
                <textarea 
                    id="prompt-input"
                    x-model="promptText"
                    placeholder="e.g., a beautiful landscape with mountains and trees, digital art style..."
                    rows="4"
                    class="form-textarea"
                ></textarea>
            </div>

            <!-- Advanced Settings -->
            <div class="additional-settings-container">
                <div class="slider-group">
                    <label class="form-label">
                        Number of Results: <span x-text="promptLimit"></span>
                    </label>
                    <input 
                        type="range" 
                        x-model.number="promptLimit" 
                        min="5" 
                        max="20" 
                        step="1"
                        class="form-range"
                    />
                </div>
                <div class="flex items-center">
                    <input 
                        type="checkbox" 
                        x-model="promptIncludeInactive"
                        class="form-checkbox"
                    />
                    <label class="ml-2 block text-sm text-gray-700">Include inactive LoRAs</label>
                </div>
            </div>

            <!-- Search Button -->
            <button 
                @click="searchByPrompt()" 
                :disabled="promptText.trim().length === 0"
                class="btn btn-success w-full"
                :class="{ 'btn-disabled': promptText.trim().length === 0 }"
            >
                <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                </svg>
                Get Recommendations
            </button>
        </div>

        <!-- Prompt Results -->
        <div x-show="promptText.length > 0" x-transition>
            <div 
                id="prompt-results"
                hx-post="/api/htmx/recommendations/prompt"
                hx-trigger="prompt-search from:body"
                hx-include="[data-prompt]"
                class="results-container"
            >
                <!-- Results will be loaded here -->
                <div class="placeholder-message">
                    <svg class="placeholder-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    <p class="placeholder-text">Enter a prompt to see recommendations</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Embedding Status Tab -->
    <div x-show="activeTab === 'status'" x-transition class="tab-content">
        <div 
            id="embedding-status-content"
            hx-get="/api/htmx/recommendations/embedding-status"
            hx-trigger="load, every 30s"
        >
            <!-- Loading placeholder -->
            <div class="animate-pulse">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-gray-200 rounded-lg h-32"></div>
                    <div class="bg-gray-200 rounded-lg h-32"></div>
                    <div class="bg-gray-200 rounded-lg h-32"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden form inputs for HTMX -->
    <div class="hidden">
        <input type="hidden" name="lora_id" :value="selectedLoraId" data-similarity />
        <input type="hidden" name="semantic_weight" :value="weights.semantic" data-similarity />
        <input type="hidden" name="artistic_weight" :value="weights.artistic" data-similarity />
        <input type="hidden" name="technical_weight" :value="weights.technical" data-similarity />
        <input type="hidden" name="limit" :value="similarityLimit" data-similarity />
        <input type="hidden" name="threshold" :value="similarityThreshold" data-similarity />
        
        <input type="hidden" name="prompt" :value="promptText" data-prompt />
        <input type="hidden" name="limit" :value="promptLimit" data-prompt />
        <input type="hidden" name="include_inactive" :value="promptIncludeInactive" data-prompt />
    </div>
</div>

<script>
    // recommendationsData is registered globally in app/frontend/static/js/alpine-config.js
</script>

<style>
/* Custom slider styles */
.slider-blue::-webkit-slider-thumb {
    background: #3B82F6;
}
.slider-purple::-webkit-slider-thumb {
    background: #8B5CF6;
}
.slider-orange::-webkit-slider-thumb {
    background: #F97316;
}

.slider-blue::-moz-range-thumb {
    background: #3B82F6;
}
.slider-purple::-moz-range-thumb {
    background: #8B5CF6;
}
.slider-orange::-moz-range-thumb {
    background: #F97316;
}
</style>
{% endblock %}
