{% extends "base.html" %}

{% block title %}Generation Studio - Component Composition Example{% endblock %}

{% block content %}
<!-- Global Notifications (Fixed positioned) -->
<div class="fixed top-4 right-4 z-50 max-w-sm" x-data="notifications">
    <template x-for="notification in notifications" :key="notification.id">
        <div :class="getNotificationClasses(notification.type)"
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 transform translate-x-full"
             x-transition:enter-end="opacity-100 transform translate-x-0"
             x-transition:leave="transition ease-in duration-200"
             x-transition:leave-start="opacity-100 transform translate-x-0"
             x-transition:leave-end="opacity-0 transform translate-x-full">
            
            <div class="flex items-center">
                <span x-text="getNotificationIcon(notification.type)" class="mr-2"></span>
                <span x-text="notification.message" class="flex-1"></span>
                <button @click="dismissNotification(notification.id)" 
                        class="ml-2 text-lg leading-none hover:opacity-70">
                    ×
                </button>
            </div>
        </div>
    </template>
</div>

<div class="container mx-auto px-4 py-6">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <!-- Main Generation Form -->
        <div class="lg:col-span-2">
            <div class="card" x-data="generationForm" x-show="isInitialized">
                <div class="card-header">
                    <h2 class="card-title">Generate Images</h2>
                    <p class="text-sm text-gray-600">Create AI-generated images with custom parameters</p>
                </div>
                
                <div class="card-body space-y-4">
                    <!-- Prompt Input -->
                    <div>
                        <label class="form-label">Prompt</label>
                        <textarea x-model="params.prompt" 
                                  class="form-input h-24" 
                                  placeholder="Describe what you want to generate..."></textarea>
                        <div class="text-xs text-gray-500 mt-1">
                            Characters: <span x-text="params.prompt.length"></span>
                        </div>
                    </div>
                    
                    <!-- Negative Prompt -->
                    <div>
                        <label class="form-label">Negative Prompt (Optional)</label>
                        <textarea x-model="params.negative_prompt" 
                                  class="form-input h-16" 
                                  placeholder="What to avoid in the generation..."></textarea>
                    </div>
                    
                    <!-- Generation Parameters -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="form-label">Width</label>
                            <input type="number" x-model="params.width" class="form-input" min="128" max="2048" step="64">
                        </div>
                        <div>
                            <label class="form-label">Height</label>
                            <input type="number" x-model="params.height" class="form-input" min="128" max="2048" step="64">
                        </div>
                        <div>
                            <label class="form-label">Steps</label>
                            <input type="number" x-model="params.steps" class="form-input" min="1" max="100">
                        </div>
                        <div>
                            <label class="form-label">CFG Scale</label>
                            <input type="number" x-model="params.cfg_scale" class="form-input" min="1" max="20" step="0.1">
                        </div>
                    </div>
                    
                    <!-- Advanced Options -->
                    <details class="border rounded-lg p-3">
                        <summary class="cursor-pointer font-medium">Advanced Options</summary>
                        <div class="mt-3 space-y-3">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="form-label">Seed</label>
                                    <div class="flex gap-2">
                                        <input type="number" x-model="params.seed" class="form-input" placeholder="-1 for random">
                                        <button @click="randomSeed()" class="btn btn-outline btn-sm">Random</button>
                                    </div>
                                </div>
                                <div>
                                    <label class="form-label">Batch Size</label>
                                    <input type="number" x-model="params.batch_size" class="form-input" min="1" max="4">
                                </div>
                            </div>
                        </div>
                    </details>
                    
                    <!-- Validation Errors -->
                    <div x-show="!validation.isValid" class="alert alert-error">
                        <ul>
                            <template x-for="error in validation.errors">
                                <li x-text="error"></li>
                            </template>
                        </ul>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="flex gap-3">
                        <button @click="startGeneration()" 
                                :disabled="!canGenerate" 
                                :class="{'loading': isGenerating}"
                                class="btn btn-primary flex-1">
                            <span x-show="!isGenerating">Generate</span>
                            <span x-show="isGenerating">Generating...</span>
                        </button>
                        
                        <button @click="clearPrompt()" class="btn btn-outline">Clear</button>
                        <button @click="saveParams()" class="btn btn-outline">Save</button>
                    </div>
                    
                    <!-- Quick Stats -->
                    <div class="text-sm text-gray-600 border-t pt-3">
                        <div class="flex justify-between">
                            <span>Active Jobs: <span x-text="$store.app.activeJobs.length"></span></span>
                            <span>Recent Results: <span x-text="$store.app.recentResults.length"></span></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Sidebar with Job Queue and System Status -->
        <div class="space-y-6">
            
            <!-- System Status -->
            <div class="card" x-data="systemStatus" x-show="isInitialized">
                <div class="card-header cursor-pointer" @click="toggleExpanded()">
                    <h3 class="card-title flex items-center">
                        <span x-text="getStatusIcon(systemStatus.status)" class="mr-2"></span>
                        System Status
                        <span class="ml-auto text-xs" :class="expanded ? 'rotate-180' : ''">▼</span>
                    </h3>
                </div>
                
                <div class="card-body" x-show="expanded" x-transition>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span>GPU Status:</span>
                            <span :class="getGpuStatusColor(systemStatus.gpu_status)" x-text="systemStatus.gpu_status"></span>
                        </div>
                        
                        <div class="flex justify-between">
                            <span>Queue:</span>
                            <span x-text="queueLength + ' jobs'"></span>
                        </div>
                        
                        <div x-show="systemStatus.memory_used && systemStatus.memory_total" class="space-y-1">
                            <div class="flex justify-between text-sm">
                                <span>VRAM:</span>
                                <span x-text="formatMemory(systemStatus.memory_used, systemStatus.memory_total)"></span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-blue-600 h-2 rounded-full" 
                                     :style="`width: ${(systemStatus.memory_used / systemStatus.memory_total) * 100}%`"></div>
                            </div>
                        </div>
                        
                        <div class="text-xs text-gray-500 pt-2 border-t">
                            Last update: <span x-text="formatLastUpdate()"></span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Job Queue -->
            <div class="card" x-data="jobQueue" x-show="isInitialized">
                <div class="card-header">
                    <h3 class="card-title">Active Jobs</h3>
                    <button x-show="hasJobs" @click="clearCompleted()" class="btn btn-outline btn-sm">
                        Clear Completed
                    </button>
                </div>
                
                <div class="card-body">
                    <div x-show="!hasJobs" class="text-center py-4 text-gray-500">
                        No active jobs
                    </div>
                    
                    <div x-show="hasJobs" class="space-y-3">
                        <template x-for="job in jobs" :key="job.id">
                            <div class="border rounded-lg p-3 bg-gray-50">
                                <div class="flex justify-between items-start mb-2">
                                    <h4 class="font-medium text-sm" x-text="job.name"></h4>
                                    <button @click="cancelJob(job.id)" 
                                            x-show="job.status === 'running' || job.status === 'starting'"
                                            class="text-red-500 hover:text-red-700 text-xs">
                                        Cancel
                                    </button>
                                </div>
                                
                                <div class="flex justify-between items-center text-sm">
                                    <span :class="getStatusColor(job.status)" x-text="job.status"></span>
                                    <span class="text-gray-500" x-text="formatDuration(job.startTime)"></span>
                                </div>
                                
                                <div x-show="job.progress > 0" class="mt-2">
                                    <div class="w-full bg-gray-200 rounded-full h-1">
                                        <div class="bg-blue-600 h-1 rounded-full transition-all duration-300" 
                                             :style="`width: ${job.progress}%`"></div>
                                    </div>
                                    <div class="text-xs text-gray-500 mt-1" x-text="`${job.progress}% complete`"></div>
                                </div>
                                
                                <div x-show="job.message" class="text-xs text-gray-600 mt-1" x-text="job.message"></div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
            
        </div>
    </div>
</div>
{% endblock %}
