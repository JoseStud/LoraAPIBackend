{% extends "base.html" %}

{% block title %}Offline{% endblock %}

{% block content %}
<div class="offline-page min-h-screen flex items-center justify-center bg-gray-50" x-data="offlinePage()" x-cloak>
    <div x-show="!isInitialized" class="py-12 text-center text-gray-500 w-full">
        <svg class="animate-spin w-8 h-8 mx-auto mb-4" viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="10" stroke-width="4" class="opacity-25"></circle><path d="M4 12a8 8 0 018-8" stroke-width="4" class="opacity-75"></path></svg>
        <div>Preparing offline mode...</div>
    </div>

    <div class="max-w-md w-full text-center" x-show="isInitialized">
        
        <!-- Offline Icon -->
        <div class="mb-8">
            <svg class="mx-auto h-24 w-24 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" 
                      d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                      d="M18 8L6 20"></path>
            </svg>
        </div>
        
        <!-- Main Message -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-4">You're Offline</h1>
            <p class="text-lg text-gray-600 mb-6">
                No internet connection detected. Don't worry, you can still browse previously loaded content.
            </p>
        </div>
        
        <!-- Connection Status -->
        <div class="mb-8 p-4 rounded-lg" :class="isOnline ? 'bg-green-100 border border-green-200' : 'bg-yellow-100 border border-yellow-200'">
            <div class="flex items-center justify-center space-x-2">
                <div class="w-3 h-3 rounded-full" :class="isOnline ? 'bg-green-500' : 'bg-yellow-500'"></div>
                <span class="font-medium" :class="isOnline ? 'text-green-800' : 'text-yellow-800'" x-text="connectionStatus"></span>
            </div>
            
            <div x-show="isOnline" x-transition class="mt-2 text-sm text-green-700">
                <div class="flex items-center justify-center space-x-1">
                    <svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="m 12 2 a 10,10 0 0,1 10,10 h -4 a 6,6 0 0,0 -6,-6 z"></path>
                    </svg>
                    <span>Reconnecting...</span>
                </div>
            </div>
        </div>
        
        <!-- Offline Features -->
        <div class="mb-8">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Available Offline</h2>
            <div class="grid grid-cols-1 gap-3">
                
                <!-- Cached LoRAs -->
                <div class="offline-feature-card">
                    <div class="flex items-center space-x-3">
                        <div class="flex-shrink-0">
                            <svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                            </svg>
                        </div>
                        <div class="flex-1 text-left">
                            <div class="font-medium text-gray-900">Cached LoRAs</div>
                            <div class="text-sm text-gray-600">Browse previously loaded models</div>
                        </div>
                        <button @click="goToPage('/loras')" class="btn btn-sm btn-secondary">
                            View
                        </button>
                    </div>
                </div>
                
                <!-- Previous Generations -->
                <div class="offline-feature-card">
                    <div class="flex items-center space-x-3">
                        <div class="flex-shrink-0">
                            <svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                        </div>
                        <div class="flex-1 text-left">
                            <div class="font-medium text-gray-900">Generated Images</div>
                            <div class="text-sm text-gray-600">View cached generation results</div>
                        </div>
                        <button @click="goToPage('/generate')" class="btn btn-sm btn-secondary">
                            View
                        </button>
                    </div>
                </div>
                
                <!-- Saved Compositions -->
                <div class="offline-feature-card">
                    <div class="flex items-center space-x-3">
                        <div class="flex-shrink-0">
                            <svg class="w-6 h-6 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                            </svg>
                        </div>
                        <div class="flex-1 text-left">
                            <div class="font-medium text-gray-900">Compositions</div>
                            <div class="text-sm text-gray-600">Access saved prompts and settings</div>
                        </div>
                        <button @click="goToPage('/compose')" class="btn btn-sm btn-secondary">
                            View
                        </button>
                    </div>
                </div>
                
                <!-- Local Storage -->
                <div class="offline-feature-card">
                    <div class="flex items-center space-x-3">
                        <div class="flex-shrink-0">
                            <svg class="w-6 h-6 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 19a2 2 0 01-2-2V7a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1M5 19h14a2 2 0 002-2v-5a2 2 0 00-2-2H9a2 2 0 00-2 2v5a2 2 0 01-2 2z"></path>
                            </svg>
                        </div>
                        <div class="flex-1 text-left">
                            <div class="font-medium text-gray-900">Local Data</div>
                            <div class="text-sm text-gray-600" x-text="`${cacheSize} of cached content`"></div>
                        </div>
                        <button @click="showCacheDetails()" class="btn btn-sm btn-secondary">
                            Details
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Actions -->
        <div class="space-y-3">
            <button @click="checkConnection()" 
                    class="btn btn-primary w-full"
                    :disabled="isChecking">
                <template x-if="!isChecking">
                    <span>Check Connection</span>
                </template>
                <template x-if="isChecking">
                    <div class="flex items-center justify-center space-x-2">
                        <svg class="animate-spin w-4 h-4" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="m 12 2 a 10,10 0 0,1 10,10 h -4 a 6,6 0 0,0 -6,-6 z"></path>
                        </svg>
                        <span>Checking...</span>
                    </div>
                </template>
            </button>
            
            <button @click="goToPage('/')" class="btn btn-secondary w-full">
                Go to Dashboard
            </button>
        </div>
        
        <!-- Tips -->
        <div class="mt-8 p-4 bg-blue-50 rounded-lg border border-blue-200">
            <h3 class="font-medium text-blue-900 mb-2">ðŸ’¡ Offline Tips</h3>
            <ul class="text-sm text-blue-800 space-y-1 text-left">
                <li>â€¢ Your work is automatically saved locally</li>
                <li>â€¢ Changes will sync when you're back online</li>
                <li>â€¢ Install the app for better offline experience</li>
                <li>â€¢ Clear browser cache if you experience issues</li>
            </ul>
        </div>
        
        <!-- App Installation -->
        <div x-show="!isInstalled && showInstallOption" 
             x-transition
             class="mt-6 p-4 bg-green-50 rounded-lg border border-green-200">
            <div class="flex items-center space-x-3">
                <div class="flex-shrink-0">
                    <img src="/static/images/icons/icon-72x72.png" alt="LoRA Manager" class="w-10 h-10 rounded-lg">
                </div>
                <div class="flex-1 text-left">
                    <div class="font-medium text-green-900">Install LoRA Manager</div>
                    <div class="text-sm text-green-800">Get better offline access and faster loading</div>
                </div>
                <button @click="installApp()" class="btn btn-sm btn-success">
                    Install
                </button>
            </div>
        </div>
    </div>
    
    <!-- Cache Details Modal -->
    <div x-show="showCacheModal" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 z-50 overflow-y-auto bg-black bg-opacity-50"
         style="display: none;">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div class="ml-3 w-full">
                            <h3 class="text-lg leading-6 font-medium text-gray-900">Cache Information</h3>
                            <div class="mt-4">
                                <div class="space-y-3">
                                    <template x-for="(count, cacheName) in cacheInfo" :key="cacheName">
                                        <div class="flex justify-between items-center">
                                            <span class="text-sm font-medium text-gray-700" x-text="formatCacheName(cacheName)"></span>
                                            <span class="text-sm text-gray-600" x-text="`${count} items`"></span>
                                        </div>
                                    </template>
                                </div>
                                
                                <div class="mt-4 pt-4 border-t border-gray-200">
                                    <div class="flex justify-between items-center">
                                        <span class="font-medium text-gray-900">Total Cache Size</span>
                                        <span class="font-medium text-gray-900" x-text="cacheSize"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button @click="clearCache()" 
                            type="button" 
                            class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 sm:ml-3 sm:w-auto sm:text-sm">
                        Clear Cache
                    </button>
                    <button @click="showCacheModal = false" 
                            type="button" 
                            class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function offlinePage() {
    return {
        isOnline: navigator.onLine,
        isChecking: false,
        isInstalled: false,
        showInstallOption: false,
        showCacheModal: false,
        cacheSize: '0 MB',
        cacheInfo: {},
        connectionStatus: navigator.onLine ? 'Connected' : 'Disconnected',
        
        init() {
            this.checkInstallationStatus();
            this.updateCacheInfo();
            this.setupEventListeners();
            
            // Check connection status periodically
            setInterval(() => {
                this.updateConnectionStatus();
            }, 5000);
            // Component ready
            this.isInitialized = true;
        },
        
        setupEventListeners() {
            window.addEventListener('online', () => {
                this.isOnline = true;
                this.connectionStatus = 'Connected';
                this.redirectToOnlinePage();
            });
            
            window.addEventListener('offline', () => {
                this.isOnline = false;
                this.connectionStatus = 'Disconnected';
            });
        },
        
        checkInstallationStatus() {
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches ||
                                window.navigator.standalone ||
                                document.referrer.includes('android-app://');
            
            this.isInstalled = isStandalone;
            this.showInstallOption = !isStandalone && 'serviceWorker' in navigator;
        },
        
        async updateCacheInfo() {
            try {
                if (window.pwaManager) {
                    this.cacheInfo = await window.pwaManager.getCacheInfo() || {};
                    
                    // Estimate cache size
                    const totalItems = Object.values(this.cacheInfo).reduce((sum, count) => sum + count, 0);
                    const estimatedSizeMB = (totalItems * 50 / 1024).toFixed(1); // Rough estimate
                    this.cacheSize = `${estimatedSizeMB} MB`;
                }
            } catch (error) {
                console.error('Failed to get cache info:', error);
                this.cacheSize = 'Unknown';
            }
        },
        
        updateConnectionStatus() {
            const wasOnline = this.isOnline;
            this.isOnline = navigator.onLine;
            this.connectionStatus = this.isOnline ? 'Connected' : 'Disconnected';
            
            if (!wasOnline && this.isOnline) {
                this.redirectToOnlinePage();
            }
        },
        
        async checkConnection() {
            this.isChecking = true;
            
            try {
                // Try to fetch a small resource
                const response = await fetch('/static/manifest.json', { 
                    cache: 'no-cache',
                    mode: 'cors'
                });
                
                if (response.ok) {
                    this.isOnline = true;
                    this.connectionStatus = 'Connected';
                    this.redirectToOnlinePage();
                } else {
                    throw new Error('No connection');
                }
            } catch (error) {
                this.isOnline = false;
                this.connectionStatus = 'Still offline';
                
                // Show temporary message
                setTimeout(() => {
                    this.connectionStatus = 'Disconnected';
                }, 2000);
            } finally {
                this.isChecking = false;
            }
        },
        
        redirectToOnlinePage() {
            // Small delay to show connection success
            setTimeout(() => {
                window.location.href = '/';
            }, 1000);
        },
        
        goToPage(url) {
            window.location.href = url;
        },
        
        showCacheDetails() {
            this.showCacheModal = true;
            this.updateCacheInfo();
        },
        
        formatCacheName(cacheName) {
            const names = {
                'lora-manager-static': 'Static Assets',
                'lora-manager-dynamic': 'Dynamic Content',
                'lora-manager-images': 'Images & Media'
            };
            
            return names[cacheName] || cacheName.replace(/lora-manager-|v\d+\.\d+\.\d+/g, '').trim();
        },
        
        async clearCache() {
            try {
                if (window.pwaManager) {
                    await window.pwaManager.clearCache();
                    await this.updateCacheInfo();
                    this.showCacheModal = false;
                }
            } catch (error) {
                console.error('Failed to clear cache:', error);
            }
        },
        
        installApp() {
            if (window.pwaManager && window.pwaManager.deferredPrompt) {
                window.pwaManager.installApp();
            }
        }
    };
}
</script>
{% endblock %}
