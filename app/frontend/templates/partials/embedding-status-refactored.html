<!-- Embedding Status -->
{% from 'macros/ui_components.html' import progress_bar, status_badge, card, error_message, empty_state, action_button, tag %}

{% if error %}
    {{ error_message(error) }}
{% else %}
    <div class="embedding-status-container">
        <!-- System Overview -->
        {% call card(class="system-overview-card") %}
            <div class="card-header">
                <h4 class="card-title">Embedding System Status</h4>
                {{ status_badge(status.system_healthy, 
                    active_text="System Healthy", 
                    inactive_text="System Issues") }}
            </div>
            
            <div class="stats-grid">
                <div class="stat-item">
                    <span class="stat-label">Total LoRAs</span>
                    <span class="stat-value text-blue-600">{{ status.total_loras or 0 }}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Embedded</span>
                    <span class="stat-value text-green-600">{{ status.embedded_loras or 0 }}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Pending</span>
                    <span class="stat-value text-orange-600">{{ status.pending_loras or 0 }}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Index Size</span>
                    <span class="stat-value text-purple-600 text-xl">{{ status.index_size_mb or 0 }}MB</span>
                </div>
            </div>

            <!-- Overall Progress -->
            {% if status.total_loras and status.total_loras > 0 %}
            <div class="progress-section">
                <div class="progress-header">
                    <span class="progress-label">Embedding Progress</span>
                    <span class="progress-percentage">
                        {{ ((status.embedded_loras / status.total_loras) * 100)|round(1) }}%
                    </span>
                </div>
                {{ progress_bar(
                    (status.embedded_loras / status.total_loras) * 100, 
                    100, 
                    "bg-gradient-to-r from-green-500 to-blue-500", 
                    "h-3"
                ) }}
            </div>
            {% endif %}
        {% endcall %}

        <!-- GPU Status -->
        {% if gpu_status %}
        {% call card() %}
            <div class="card-header">
                <h5 class="card-subtitle">GPU Status</h5>
                {{ status_badge(gpu_status.available, 
                    active_text="GPU Available", 
                    inactive_text="GPU Unavailable") }}
            </div>
            
            {% if gpu_status.available %}
            <div class="stats-grid md:grid-cols-2">
                <div class="stat-item">
                    <span class="stat-label">Device</span>
                    <span class="text-gray-900">{{ gpu_status.device_name or "Unknown" }}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Memory Usage</span>
                    <div class="mt-1">
                        {{ progress_bar(
                            (gpu_status.memory_used / gpu_status.memory_total) * 100,
                            100,
                            "bg-gradient-to-r from-yellow-500 to-red-500",
                            "h-2"
                        ) }}
                        <span class="text-xs text-gray-600 mt-1 block">
                            {{ gpu_status.memory_used|round(1) }}GB / {{ gpu_status.memory_total|round(1) }}GB
                        </span>
                    </div>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Temperature</span>
                    <span class="text-gray-900">{{ gpu_status.temperature or "Unknown" }}Â°C</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Utilization</span>
                    <span class="text-gray-900">{{ gpu_status.utilization or 0 }}%</span>
                </div>
            </div>
            {% else %}
            <p class="text-sm text-gray-600">
                GPU acceleration not available. Embeddings will be computed using CPU.
            </p>
            {% endif %}
        {% endcall %}
        {% endif %}

        <!-- Processing Queue -->
        {% if processing_queue and processing_queue|length > 0 %}
        {% call card() %}
            <div class="flex items-center justify-between mb-4">
                <h5 class="font-medium text-gray-900">Processing Queue</h5>
                <span class="text-sm text-gray-600">{{ processing_queue|length }} items</span>
            </div>
            
            <div class="space-y-2">
                {% for item in processing_queue[:5] %}
                <div class="flex items-center justify-between py-2 px-3 bg-gray-50 rounded">
                    <div class="flex-1">
                        <span class="text-sm font-medium text-gray-900">{{ item.name }}</span>
                        <div class="text-xs text-gray-600">
                            {{ item.status }} - {{ item.progress or 0 }}%
                        </div>
                    </div>
                    <div class="flex-shrink-0 ml-3">
                        {% if item.status == "processing" %}
                            <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"></div>
                        {% elif item.status == "queued" %}
                            <div class="h-4 w-4 bg-gray-400 rounded-full"></div>
                        {% else %}
                            {{ status_badge(item.status == "completed") }}
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
                
                {% if processing_queue|length > 5 %}
                <div class="text-center py-2">
                    <span class="text-sm text-gray-500">
                        ... and {{ processing_queue|length - 5 }} more items
                    </span>
                </div>
                {% endif %}
            </div>
        {% endcall %}
        {% endif %}

        <!-- Recent Embeddings -->
        {% if recent_embeddings and recent_embeddings|length > 0 %}
        {% call card() %}
            <h5 class="font-medium text-gray-900 mb-4">Recently Embedded LoRAs</h5>
            
            <div class="space-y-3">
                {% for embedding in recent_embeddings[:10] %}
                <div class="flex items-center justify-between py-2 px-3 border border-gray-200 rounded">
                    <div class="flex-1">
                        <span class="text-sm font-medium text-gray-900">{{ embedding.name }}</span>
                        <div class="text-xs text-gray-600">
                            Completed {{ embedding.completed_at|timeago if embedding.completed_at else "recently" }}
                        </div>
                    </div>
                    <div class="flex items-center space-x-3">
                        <div class="text-xs text-gray-500">
                            {{ embedding.embedding_dimensions or "Unknown" }}D
                        </div>
                        {{ status_badge(True) }}
                    </div>
                </div>
                {% endfor %}
            </div>
        {% endcall %}
        {% endif %}

        <!-- Statistics -->
        {% if embedding_stats %}
        {% call card() %}
            <h5 class="font-medium text-gray-900 mb-4">Embedding Statistics</h5>
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                <div>
                    <span class="block font-medium text-gray-700">Avg Processing Time</span>
                    <span class="text-lg font-semibold text-blue-600">
                        {{ embedding_stats.avg_processing_time|round(1) }}s
                    </span>
                </div>
                <div>
                    <span class="block font-medium text-gray-700">Total Processing Time</span>
                    <span class="text-lg font-semibold text-green-600">
                        {{ embedding_stats.total_processing_time|round(1) }}s
                    </span>
                </div>
                <div>
                    <span class="block font-medium text-gray-700">Success Rate</span>
                    <span class="text-lg font-semibold text-purple-600">
                        {{ (embedding_stats.success_rate * 100)|round(1) }}%
                    </span>
                </div>
                <div>
                    <span class="block font-medium text-gray-700">Last Update</span>
                    <span class="text-lg font-semibold text-orange-600">
                        {{ embedding_stats.last_update|timeago if embedding_stats.last_update else "Never" }}
                    </span>
                </div>
            </div>
        {% endcall %}
        {% endif %}

        <!-- Index Health -->
        {% if index_health %}
        {% call card() %}
            <div class="flex items-center justify-between mb-4">
                <h5 class="font-medium text-gray-900">Index Health</h5>
                {{ status_badge(index_health.healthy) }}
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                <div>
                    <span class="block font-medium text-gray-700">Index Type</span>
                    <span class="text-gray-900">{{ index_health.index_type or "FAISS" }}</span>
                </div>
                <div>
                    <span class="block font-medium text-gray-700">Dimensions</span>
                    <span class="text-gray-900">{{ index_health.dimensions or "Unknown" }}</span>
                </div>
                <div>
                    <span class="block font-medium text-gray-700">Last Rebuilt</span>
                    <span class="text-gray-900">
                        {{ index_health.last_rebuilt|timeago if index_health.last_rebuilt else "Never" }}
                    </span>
                </div>
            </div>

            {% if index_health.issues and index_health.issues|length > 0 %}
            <div class="mt-4 p-3 bg-red-50 rounded-lg">
                <h6 class="text-sm font-medium text-red-800 mb-2">Issues Detected:</h6>
                <ul class="text-sm text-red-700 space-y-1">
                    {% for issue in index_health.issues %}
                    <li class="flex items-start">
                        <svg class="w-4 h-4 mr-1 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                        </svg>
                        {{ issue }}
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        {% endcall %}
        {% endif %}

        <!-- Actions -->
        <div class="flex flex-wrap gap-3">
            {{ action_button(
                onclick="refreshEmbeddingStatus()",
                text="Refresh Status",
                icon_svg='<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>',
                variant="secondary"
            ) }}
            
            {% if status.pending_loras and status.pending_loras > 0 %}
            {{ action_button(
                onclick="processPendingEmbeddings()",
                text="Process Pending (" + status.pending_loras|string + ")",
                icon_svg='<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1m4 0h1m-6 4h.01M19 10a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>',
                variant="primary"
            ) }}
            {% endif %}
            
            {% if index_health and not index_health.healthy %}
            {{ action_button(
                onclick="rebuildIndex()",
                text="Rebuild Index",
                icon_svg='<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>',
                variant="warning"
            ) }}
            {% endif %}
            
            {{ action_button(
                onclick="exportEmbeddings()",
                text="Export Data",
                icon_svg='<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>',
                variant="secondary"
            ) }}
        </div>
    </div>
{% endif %}
