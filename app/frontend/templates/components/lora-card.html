<!-- LoRA Card Component Template -->
<!-- Can be used in both grid and list views -->

{% macro lora_card(lora, view_mode='grid', bulk_mode=false) %}
<div x-data='loraCard({{ lora.json | safe }})'
     class="lora-card-wrapper {{ 'lora-card-grid' if view_mode == 'grid' else 'lora-card-list' }}">
    
    {% if view_mode == 'grid' %}
    <!-- Grid View -->
    <div class="lora-card-grid-inner">
        <!-- Selection checkbox for bulk mode -->
        <div x-show="bulkMode" class="lora-card-checkbox-container">
            <input type="checkbox" 
                   :checked="isSelected"
                   @change="toggleSelection()"
                   class="form-checkbox">
        </div>
        
        <!-- LoRA Image/Preview -->
        <div class="lora-card-preview-container">
            <div class="lora-card-preview-aspect">
                {% if lora.preview_image %}
                <img src="{{ lora.preview_image }}" 
                     alt="{{ lora.name }}"
                     class="lora-card-preview-image">
                {% else %}
                <div class="lora-card-preview-placeholder">
                    <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                              d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                    </svg>
                </div>
                {% endif %}
            </div>
            
            <!-- Status Badge -->
            <div class="lora-card-status-badge-container">
                <span class="status-badge {{ 'status-active' if lora.active else 'status-inactive' }}">
                    {{ 'Active' if lora.active else 'Inactive' }}
                </span>
            </div>
            
            <!-- Quality Score -->
            {% if lora.quality_score %}
            <div class="lora-card-quality-score-container">
                <div class="quality-score-badge">
                    <span class="text-white text-xs">⭐ {{ "%.1f"|format(lora.quality_score) }}</span>
                </div>
            </div>
            {% endif %}
        </div>
        
        <!-- Card Content -->
        <div class="lora-card-content">
            <!-- Header -->
            <div class="lora-card-header">
                <h3 class="lora-card-title">
                    {{ lora.name }}
                </h3>
                <!-- Quick Actions Dropdown -->
                <div x-data="{ open: false }" class="relative">
                    <button @click="open = !open" 
                            class="lora-card-actions-btn">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"></path>
                        </svg>
                    </button>
                    <div x-show="open" 
                         @click.away="open = false"
                         x-transition
                         class="lora-card-actions-menu">
                        <div class="py-1">
                            <a href="/loras/{{ lora.id }}" 
                               class="lora-card-menu-item">
                                View Details
                            </a>
                            <button @click="toggleActive()" 
                                    class="lora-card-menu-item w-full text-left">
                                <span x-text="active ? 'Deactivate' : 'Activate'"></span>
                            </button>
                            <button @click="getRecommendations()" 
                                    class="lora-card-menu-item w-full text-left">
                                Find Similar
                            </button>
                            <button @click="generatePreview()" 
                                    class="lora-card-menu-item w-full text-left">
                                Generate Preview
                            </button>
                            <div class="lora-card-menu-divider"></div>
                            <button @click="deleteLora()" 
                                    class="lora-card-menu-item-danger w-full text-left">
                                Delete
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Version and Type -->
            <div class="lora-card-meta">
                {% if lora.version %}
                <span class="text-xs text-gray-500">v{{ lora.version }}</span>
                {% endif %}
                {% if lora.type %}
                <span class="tag tag-blue">
                    {{ lora.type }}
                </span>
                {% endif %}
            </div>
            
            <!-- Description -->
            {% if lora.description %}
            <p class="lora-card-description">
                {{ lora.description }}
            </p>
            {% endif %}
            
            <!-- Tags -->
            {% if lora.tags %}
            <div class="lora-card-tags">
                {% for tag in lora.tags[:3] %}
                <span class="tag">
                    {{ tag }}
                </span>
                {% endfor %}
                {% if lora.tags|length > 3 %}
                <span class="text-xs text-gray-500">+{{ lora.tags|length - 3 }} more</span>
                {% endif %}
            </div>
            {% endif %}
            
            <!-- Weight Control -->
            {% if lora.active %}
            <div class="lora-card-weight-control">
                <label class="form-label text-xs">Weight</label>
                <input type="range" 
                       x-model="weight" 
                       @input="updateWeight()"
                       min="0" max="2" step="0.1" 
                       class="form-range w-full">
                <div class="flex justify-between text-xs text-gray-500">
                    <span>0</span>
                    <span class="font-medium" x-text="weight"></span>
                    <span>2.0</span>
                </div>
            </div>
            {% endif %}
            
            <!-- Action Buttons -->
            <div class="lora-card-actions">
                <button @click="toggleActive()" 
                        :class="active ? 'btn-secondary' : 'btn-primary'"
                        class="btn flex-1">
                    <span x-text="active ? 'Deactivate' : 'Activate'"></span>
                </button>
                <button @click="getRecommendations()" 
                        class="btn btn-secondary px-3">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                              d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>
    
    {% else %}
    <!-- List View -->
    <div class="lora-card-list-inner">
        <div class="p-4">
            <div class="flex items-center space-x-4">
                <!-- Selection checkbox for bulk mode -->
                <div x-show="bulkMode">
                    <input type="checkbox" 
                           :checked="isSelected"
                           @change="toggleSelection()"
                           class="form-checkbox">
                </div>
                
                <!-- Thumbnail -->
                <div class="flex-shrink-0">
                    <div class="lora-card-list-thumbnail">
                        {% if lora.preview_image %}
                        <img src="{{ lora.preview_image }}" 
                             alt="{{ lora.name }}"
                             class="w-full h-full object-cover">
                        {% else %}
                        <div class="lora-card-preview-placeholder">
                            <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                      d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                            </svg>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Content -->
                <div class="flex-1 min-w-0">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <h3 class="lora-card-title text-sm">
                                {{ lora.name }}
                            </h3>
                            {% if lora.version %}
                            <span class="text-xs text-gray-500">v{{ lora.version }}</span>
                            {% endif %}
                            <span class="status-badge {{ 'status-active' if lora.active else 'status-inactive' }}">
                                {{ 'Active' if lora.active else 'Inactive' }}
                            </span>
                        </div>
                        
                        <!-- Weight Control (if active) -->
                        {% if lora.active %}
                        <div class="flex items-center space-x-3">
                            <div class="flex items-center space-x-2">
                                <span class="text-xs text-gray-600">Weight:</span>
                                <input type="range" 
                                       x-model="weight" 
                                       @input="updateWeight()"
                                       min="0" max="2" step="0.1" 
                                       class="w-20">
                                <span class="text-xs font-medium w-8" x-text="weight"></span>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Description and Tags -->
                    <div class="mt-1 flex items-center space-x-4">
                        {% if lora.description %}
                        <p class="lora-card-description text-sm flex-1">
                            {{ lora.description }}
                        </p>
                        {% endif %}
                        
                        {% if lora.tags %}
                        <div class="flex space-x-1">
                            {% for tag in lora.tags[:2] %}
                            <span class="tag">
                                {{ tag }}
                            </span>
                            {% endfor %}
                            {% if lora.tags|length > 2 %}
                            <span class="text-xs text-gray-500">+{{ lora.tags|length - 2 }}</span>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Actions -->
                <div class="flex items-center space-x-2">
                    <button @click="toggleActive()" 
                            :class="active ? 'btn-secondary' : 'btn-primary'"
                            class="btn btn-sm">
                        <span x-text="active ? 'Deactivate' : 'Activate'"></span>
                    </button>
                    <a href="/loras/{{ lora.id }}" 
                       class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                        View →
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
function loraCard(config) {
    return {
        id: config.id,
        active: config.active || false,
        name: config.name,
        version: config.version,
        viewMode: config.viewMode || 'grid',
        bulkMode: config.bulkMode || false,
        weight: 1.0,
        isSelected: false, // Initialize isSelected
        
        toggleActive() {
            this.active = !this.active;
            const endpoint = this.active ? 'activate' : 'deactivate';
            fetch(`/api/v1/adapters/${this.id}/${endpoint}`, {
                method: 'POST'
            }).then(response => {
                if (!response.ok) {
                    this.active = !this.active; // Revert on error
                    console.error('Failed to toggle LoRA status');
                }
            });
        },
        
        updateWeight() {
            // Update weight via API
            fetch(`/api/v1/adapters/${this.id}/weight`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ weight: parseFloat(this.weight) })
            });
        },
        
        toggleSelection() {
            this.isSelected = !this.isSelected;
            // Notify parent component
            if (this.isSelected) {
                // Primary event (current implementation)
                window.dispatchEvent(new CustomEvent('lora-selected', { detail: { id: this.id } }));
                // Legacy compatibility: also emit the older combined event shape
                window.dispatchEvent(new CustomEvent('lora-selection-changed', { detail: { loraId: this.id, selected: true } }));
            } else {
                window.dispatchEvent(new CustomEvent('lora-deselected', { detail: { id: this.id } }));
                window.dispatchEvent(new CustomEvent('lora-selection-changed', { detail: { loraId: this.id, selected: false } }));
            }
        },
        
        async getRecommendations() {
            // Navigate to recommendations page with this LoRA
            window.location.href = `/recommendations?similar=${this.id}`;
        },
        
        async generatePreview() {
            // Trigger preview generation
            try {
                const response = await fetch(`/api/v1/generation/preview/${this.id}`, {
                    method: 'POST'
                });
                if (response.ok) {
                    alert('Preview generation started');
                } else {
                    alert('Failed to start preview generation');
                }
            } catch (error) {
                alert('Error generating preview');
            }
        },
        
        async deleteLora() {
            if (confirm(`Delete ${this.name}? This cannot be undone.`)) {
                try {
                    const response = await fetch(`/api/v1/adapters/${this.id}`, {
                        method: 'DELETE'
                    });
                    if (response.ok) {
                        // Remove the card from view
                        this.$el.remove();
                    } else {
                        alert('Failed to delete LoRA');
                    }
                } catch (error) {
                    alert('Error deleting LoRA');
                }
            }
        }
    }
}
</script>
{% endmacro %}
